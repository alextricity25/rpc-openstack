---
# Copyright 2014-2017, Rackspace US, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
- name: Install Octavia
  hosts: localhost
  tasks:
    - name: Add Octavia to the Requirements list
      blockinfile:
        dest: '{{ oa_dir }}/ansible-role-requirements.yml'
        block: |
          - name: os_octavia
            scm: git
            src: https://github.com/openstack/openstack-ansible-os_octavia.git
            version: master
    - name: Turn on 'isolated' mode for Octavia PIP
      lineinfile:
        dest: '{{ oa_dir }}/playbooks/inventory/group_vars/octavia_all.yml'
        regexp: '{{ item.regex }}'
        line: '{{ item.line }}'
        backup: yes
        state: present
      with_items:
        - regex: '^pip_install_options:'
          line: 'pip_install_options: --isolated'
        - regex: '^octavia_developer_mode:'
          line: 'octavia_developer_mode: True'
        - regex: '^octavia_git_install_branch:'
          line: 'octavia_git_install_branch: {{ octavia_git_install_branch }}'

    - name: Set OSA variable overrides
      blockinfile:
        dest: '/etc/openstack_deploy/user_osa_variables_overrides.yml'
        block: '{{ item.block }}'
        marker: '# {mark} MAGNUM SETTING: {{ item.name }}'
        state: present
        backup: yes
      with_items:
        - block: |
            octavia_loadbalancer_topology: ACTIVE_STANDBY
          name: Octavia Active/Passive Topology
        - block: |
            repo_build_git_selective: False
          name: Git Repo Selective Build
  vars:
    oa_dir: '/opt/rpc-openstack/openstack-ansible'
    octavia_git_install_branch: 'master'
